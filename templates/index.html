<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>DayPlan - Personal Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="app-container">
        <!-- Left Sidebar - Statistics -->
        <aside class="sidebar sidebar-left" role="complementary" aria-label="Statistics and exports">
            <div class="sidebar-header">
                <h1 class="logo">ðŸ“… DayPlan</h1>
            </div>
            
            <div class="stats-section">
                <h3>All-Time Stats</h3>
                <div class="stat-card">
                    <span class="stat-value">{{ stats.total_days }}</span>
                    <span class="stat-label">Days Tracked</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ stats.total_tasks }}</span>
                    <span class="stat-label">Total Tasks</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ stats.completed_tasks }}</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-card highlight">
                    <span class="stat-value">{{ "%.0f"|format(stats.completion_rate) }}%</span>
                    <span class="stat-label">Completion Rate</span>
                </div>
            </div>
            
            <div class="export-section">
                <h3>Export Data</h3>
                <a href="/export/json" class="btn btn-export">ðŸ“„ Export JSON</a>
                <a href="/export/csv" class="btn btn-export">ðŸ“Š Export CSV</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Tab Navigation -->
            <div class="tab-navigation" role="tablist" aria-label="Main navigation">
                <button class="tab-btn active" data-tab="calendar" onclick="switchTab('calendar')" role="tab" aria-selected="true" aria-controls="calendar-tab" id="tab-calendar">ðŸ“… Calendar</button>
                <button class="tab-btn" data-tab="collections" onclick="switchTab('collections')" role="tab" aria-selected="false" aria-controls="collections-tab" id="tab-collections">ðŸ“š Collections</button>
            </div>

            <!-- Calendar Tab -->
            <div class="tab-content active" id="calendar-tab" role="tabpanel" aria-labelledby="tab-calendar">
                <!-- Monthly Summary Bar -->
                <div class="monthly-summary">
                    <div class="summary-stat">
                        <span class="summary-icon">ðŸ“…</span>
                        <span class="summary-value">{{ monthly_stats.days_with_tasks }}</span>
                        <span class="summary-label">Active Days</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-icon">ðŸ“‹</span>
                        <span class="summary-value">{{ monthly_stats.total_tasks }}</span>
                        <span class="summary-label">Tasks</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-icon">âœ…</span>
                        <span class="summary-value">{{ monthly_stats.completed_tasks }}</span>
                        <span class="summary-label">Done</span>
                    </div>
                    <div class="summary-stat highlight">
                        <span class="summary-icon">ðŸ“ˆ</span>
                        <span class="summary-value">{{ "%.0f"|format(monthly_stats.completion_rate) }}%</span>
                        <span class="summary-label">This Month</span>
                    </div>
                </div>

                <!-- Calendar Header -->
                <div class="calendar-header">
                    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="nav-btn" aria-label="Previous month">â€¹</a>
                    <h2 class="month-title" aria-live="polite">{{ month_name }} {{ year }}</h2>
                    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="nav-btn" aria-label="Next month">â€º</a>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid" role="grid" aria-label="Calendar for {{ month_name }} {{ year }}">
                <div class="weekday-header" role="columnheader">Sun</div>
                <div class="weekday-header" role="columnheader">Mon</div>
                <div class="weekday-header" role="columnheader">Tue</div>
                <div class="weekday-header" role="columnheader">Wed</div>
                <div class="weekday-header" role="columnheader">Thu</div>
                <div class="weekday-header" role="columnheader">Fri</div>
                <div class="weekday-header" role="columnheader">Sat</div>
                
                {% for cell in calendar_days %}
                    {% if cell is none %}
                        <div class="calendar-day empty" role="gridcell" aria-hidden="true"></div>
                    {% else %}
                        <div class="calendar-day {{ 'today' if cell.is_today else '' }} {{ 'selected' if selected_day and selected_day.id == cell.day.id else '' }}"
                             role="gridcell"
                             tabindex="0"
                             data-day-id="{{ cell.day.id }}"
                             data-date="{{ cell.day.date }}"
                             onclick="selectDay('{{ cell.day.id }}', '{{ cell.day.date }}')"
                             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectDay('{{ cell.day.id }}', '{{ cell.day.date }}')}"
                             aria-label="{{ cell.day.date }}{% if cell.is_today %} (today){% endif %}, {{ cell.day.tasks|length }} task{{ 's' if cell.day.tasks|length != 1 else '' }}">
                            <span class="day-number">{{ cell.day_num }}</span>
                            {% if cell.day.tasks %}
                                <div class="day-indicators" aria-hidden="true">
                                    {% for task in cell.day.tasks[:3] %}
                                        <span class="task-dot {{ task.status.value }}" title="{{ task.title }}: {{ task.status.value }}"></span>
                                    {% endfor %}
                                    {% if cell.day.tasks|length > 3 %}
                                        <span class="more-indicator">+{{ cell.day.tasks|length - 3 }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
                </div>
            </div>
            <!-- End Calendar Tab -->

            <!-- Collections Tab -->
            <div class="tab-content" id="collections-tab" role="tabpanel" aria-labelledby="tab-collections">
                <div class="collections-header">
                    <h2>Collections</h2>
                    <button class="btn btn-primary" onclick="showNewCollectionForm()">+ New Collection</button>
                </div>

                <div class="collections-container" id="collectionsContainer" aria-live="polite">
                    <!-- Collections will be loaded here by JavaScript -->
                    <div class="loading-message">Loading collections...</div>
                </div>
            </div>
            <!-- End Collections Tab -->
        </main>

        <!-- Right Sidebar - Day Details / Collection Details -->
        <aside class="sidebar sidebar-right" role="complementary" aria-label="Day details">
            <div class="day-panel" id="dayPanel">
                {% if selected_day %}
                    <div class="panel-header">
                        <h2 class="panel-date">{{ selected_date }}</h2>
                        <span class="panel-badge">{{ selected_day.tasks|length }} tasks</span>
                    </div>
                    
                    <div class="task-list" id="taskList" aria-live="polite" aria-label="Task list">
                        {% for task in selected_day.tasks %}
                            <div class="task-item {{ task.status.value }}" data-task-id="{{ task.id }}" role="article" aria-label="Task: {{ task.title }}">
                                <div class="task-header" onclick="toggleTaskExpand('{{ selected_day.id }}', '{{ task.id }}')" aria-expanded="{{ 'true' if task.is_expanded else 'false' }}">
                                    <span class="expand-icon" aria-hidden="true">{{ 'â–¼' if task.is_expanded else 'â–¶' }}</span>
                                    <input type="checkbox" 
                                           class="task-checkbox"
                                           {{ 'checked' if task.completed else '' }}
                                           onclick="event.stopPropagation(); toggleTask('{{ selected_day.id }}', '{{ task.id }}')"
                                           id="task-{{ task.id }}"
                                           aria-label="Mark '{{ task.title }}' as {{ 'incomplete' if task.completed else 'complete' }}">
                                    <label class="task-title" for="task-{{ task.id }}" data-editable="true" onclick="event.stopPropagation(); enableTaskEdit(event, '{{ selected_day.id }}', '{{ task.id }}')">{{ task.title }}</label>
                                    <button class="btn-icon delete-btn" onclick="event.stopPropagation(); deleteTask('{{ selected_day.id }}', '{{ task.id }}')" title="Delete task" aria-label="Delete task '{{ task.title }}'">Ã—</button>
                                </div>
                                
                                <div class="subtask-container {{ 'expanded' if task.is_expanded else 'collapsed' }}">
                                    {% if task.subtasks %}
                                        <div class="subtask-progress" role="group" aria-label="Subtask progress">
                                            <div class="progress-bar" role="progressbar" 
                                                 aria-valuenow="{{ task.subtasks|selectattr('completed')|list|length }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="{{ task.subtasks|length }}"
                                                 aria-label="{{ task.subtasks|selectattr('completed')|list|length }} of {{ task.subtasks|length }} subtasks completed">
                                                <div class="progress-fill" style="width: {{ (task.subtasks|selectattr('completed')|list|length / task.subtasks|length * 100) if task.subtasks else 0 }}%"></div>
                                            </div>
                                            <span class="progress-text">{{ task.subtasks|selectattr('completed')|list|length }} of {{ task.subtasks|length }}</span>
                                        </div>
                                        <ul class="subtask-list">
                                            {% for subtask in task.subtasks %}
                                                <li class="subtask-item">
                                                    <input type="checkbox" 
                                                           class="subtask-checkbox"
                                                           {{ 'checked' if subtask.completed else '' }}
                                                           onclick="toggleSubtask('{{ selected_day.id }}', '{{ task.id }}', '{{ subtask.id }}')"
                                                           id="subtask-{{ subtask.id }}"
                                                           aria-label="Mark '{{ subtask.title }}' as {{ 'incomplete' if subtask.completed else 'complete' }}">
                                                    <label for="subtask-{{ subtask.id }}">{{ subtask.title }}</label>
                                                    <button class="btn-icon-sm" onclick="deleteSubtask('{{ selected_day.id }}', '{{ task.id }}', '{{ subtask.id }}')" title="Delete subtask" aria-label="Delete subtask '{{ subtask.title }}'">Ã—</button>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                    
                                    <div class="add-subtask">
                                        <input type="text" 
                                               class="subtask-input" 
                                               placeholder="Add subtask..."
                                               id="subtask-input-{{ task.id }}"
                                               aria-label="Add subtask to '{{ task.title }}'"
                                               onkeypress="if(event.key==='Enter') addSubtask('{{ selected_day.id }}', '{{ task.id }}')">
                                        <button class="btn-add-subtask" onclick="addSubtask('{{ selected_day.id }}', '{{ task.id }}')" aria-label="Add subtask">+</button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="add-task-form">
                        <input type="text" id="newTaskInput" placeholder="Add new task..." 
                               aria-label="New task title"
                               onkeypress="if(event.key==='Enter') addPanelTask('{{ selected_day.id }}')">
                        <button class="btn btn-primary" id="addTaskBtn" onclick="addPanelTask('{{ selected_day.id }}')" aria-label="Add new task">Add</button>
                    </div>
                {% else %}
                    <div class="empty-panel">
                        <span class="empty-icon">ðŸ“†</span>
                        <p>Select a day to view tasks</p>
                    </div>
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- ========================================
         Modals
         ======================================== -->

    <!-- Modal backdrop -->
    <div id="modalBackdrop" class="modal-backdrop" onclick="closeActiveModal()"></div>

    <!-- Collection creation modal -->
    <div id="collectionModal" class="modal" role="dialog" aria-labelledby="collectionModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="collectionModalTitle">New Collection</h2>
                <button class="modal-close" onclick="closeModal('collectionModal')" aria-label="Close modal">Ã—</button>
            </div>
            
            <form id="collectionForm" onsubmit="handleCollectionFormSubmit(event)">
                <div class="form-group">
                    <label for="collectionName">Collection Name *</label>
                    <input type="text" id="collectionName" name="name" required 
                           placeholder="e.g., Shopping, Projects, Ideas"
                           minlength="1" maxlength="200">
                    <span class="error-message" id="nameError"></span>
                </div>
                
                <div class="form-group">
                    <label for="collectionDescription">Description</label>
                    <textarea id="collectionDescription" name="description" 
                              placeholder="What is this collection for?"
                              maxlength="500" rows="3"></textarea>
                    <span class="error-message" id="descriptionError"></span>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal('collectionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Collection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation dialog modal -->
    <div id="confirmModal" class="modal" role="alertdialog" aria-labelledby="confirmTitle" aria-describedby="confirmMessage" aria-modal="true">
        <div class="modal-content modal-content-sm">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirm</h2>
                <button class="modal-close" onclick="closeModal('confirmModal')" aria-label="Close">Ã—</button>
            </div>
            <p id="confirmMessage" class="confirm-message">Are you sure?</p>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeModal('confirmModal')" id="confirmCancelBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmOkBtn">Delete</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
